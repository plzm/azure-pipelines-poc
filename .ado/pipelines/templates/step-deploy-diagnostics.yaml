parameters:
- name: TaskName
  displayName: 'Task name'
  type: string
  default: 'Deploy Diagnostics'
- name: ResourceGroupName
  displayName: 'Resource Group to deploy to'
  type: string
- name: ResourceId
  displayName: 'Resource ID that is getting the diagnostics setting'
  type: string
- name: SendAllLogs
  displayName: 'Send all logs'
  type: string
  default: true
- name: SendMetrics
  displayName: 'Send metrics'
  type: string
  default: true

steps:
- task: AzureCLI@2
  displayName: "${{ parameters.TaskName }}"
  inputs:
    azureSubscription: '$(AzureServiceConnection)'
    scriptType: pscore
    scriptLocation: inlineScript
    inlineScript: |
      . ./azure-pipelines-poc/scripts/Module.ps1
      Import-PlzmAzureModule

      $output = plzm.Azure\Deploy-DiagnosticsSetting `
        -SubscriptionID "$(AzureSubscriptionId)" `
        -ResourceGroupName ${{ parameters.ResourceGroupName }} `
        -TemplateUri "($(UriPrefixArmTemplates) + 'diagnostic-settings.json')" `
        -ResourceId "${{ parameters.ResourceId }}" `
        -DiagnosticsSettingName ("diag-" + "$(LogAnalyticsWorkspaceName)") `
        -LogAnalyticsWorkspaceResourceId "$(LogAnalyticsWorkspaceResourceId)" `
        -SendAllLogs ${{ parameters.SendAllLogs }} `
        -SendMetrics ${{ parameters.SendMetrics }}

      Write-Debug -Debug:$true -Message "$output"